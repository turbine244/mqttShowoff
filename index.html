<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>MQTT ì†¡ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 30px auto; }
    fieldset { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    legend { font-weight: bold; }
    input[type="text"] { width: 100%; padding: 8px; font-size: 16px; margin-top: 4px; margin-bottom: 10px; }
    button { padding: 8px 16px; font-size: 16px; cursor: pointer; }
    #log { border: 1px solid #ccc; background: #fafafa; padding: 10px; height: 250px; overflow-y: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>MQTT ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</h2>

  <fieldset>
    <legend>ğŸ“¤ Publish</legend>
    <label>í† í”½:</label>
    <input id="pubTopic" type="text" value="test/topic" placeholder="ë³´ë‚¼ í† í”½ ì…ë ¥">
    <label>ë©”ì‹œì§€:</label>
    <input id="msg" type="text" placeholder="ë³´ë‚¼ ë©”ì‹œì§€ ì…ë ¥">
    <button id="sendBtn">ë³´ë‚´ê¸°</button>
  </fieldset>

  <fieldset>
    <legend>ğŸ“¥ Subscribe</legend>
    <label>êµ¬ë…í•  í† í”½:</label>
    <input id="subTopic" type="text" value="test/topic" placeholder="êµ¬ë…í•  í† í”½ ì…ë ¥">
    <button id="subBtn">êµ¬ë… ì‹œì‘</button>
  </fieldset>

  <fieldset>
    <legend>ğŸ“œ ìˆ˜ì‹  ë¡œê·¸</legend>
    <div id="log"></div>
  </fieldset>

  <script>
    // ë¸Œë¡œì»¤ ì£¼ì†Œ (WebSocket ì „ìš© í¬íŠ¸)
    const BROKER_URL = "wss://165.246.44.72:1999";

    const logBox = document.getElementById("log");
    function log(msg) {
      logBox.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    log(`ë¸Œë¡œì»¤ ì—°ê²° ì¤‘... (${BROKER_URL})`);
    const client = mqtt.connect(BROKER_URL);

    client.on("connect", () => {
      log("âœ… ì—°ê²° ì„±ê³µ");
      document.getElementById("sendBtn").disabled = false;
      document.getElementById("subBtn").disabled = false;
    });

    client.on("error", (err) => {
      log("âŒ ì—°ê²° ì˜¤ë¥˜: " + err.message);
    });

    // ------------------ Publish ------------------
    document.getElementById("sendBtn").addEventListener("click", () => {
      const topic = document.getElementById("pubTopic").value.trim();
      const msg = document.getElementById("msg").value.trim();
      if (!topic || !msg) {
        log("âš ï¸ í† í”½ê³¼ ë©”ì‹œì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      client.publish(topic, msg, { qos: 0 }, (err) => {
        if (err) log("ì „ì†¡ ì‹¤íŒ¨: " + err.message);
        else log(`ğŸ“¤ ë³´ëƒ„ â†’ [${topic}] ${msg}`);
      });
      document.getElementById("msg").value = "";
    });

    // ------------------ Subscribe ------------------
    document.getElementById("subBtn").addEventListener("click", () => {
      const topic = document.getElementById("subTopic").value.trim();
      if (!topic) {
        log("âš ï¸ êµ¬ë…í•  í† í”½ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      client.subscribe(topic, { qos: 0 }, (err) => {
        if (err) log("êµ¬ë… ì‹¤íŒ¨: " + err.message);
        else log(`ğŸ“¥ êµ¬ë… ì‹œì‘: [${topic}]`);
      });
    });

    // ------------------ Message Listener ------------------
    client.on("message", (topic, message) => {
      const payload = new TextDecoder("utf-8").decode(message);
      log(`ğŸ“© ìˆ˜ì‹  â†’ [${topic}] ${payload}`);
    });
  </script>
</body>
</html>
